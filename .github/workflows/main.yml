name: CI
on: 
  push:
    branches:
      - 'main'
jobs:
  xqerl-cli:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: `make` commands check
        run: |
          echo ' list "make" available commands'
          echo '> make
          make
          printf %60s | tr ' ' '-' && echo
      - name: Set up local bin
        run: |
          mkdir -p $HOME/.local/bin
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          pushd $HOME/.local/bin && ln -s ${GITHUB_WORKSPACE}/bin/xq && popd
          which xq
      - name: Github login in and pull helper github packages
        run: |
          echo "Home: ${HOME}"
          echo "GITHUB_WORKFLOW: ${GITHUB_WORKFLOW}"
          echo "GITHUB_ACTIONS: ${GITHUB_ACTIONS}"
          echo "GITHUB_ACTOR: ${GITHUB_ACTOR}"
          echo "GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          echo "GITHUB_EVENT_NAME: ${GITHUB_EVENT_NAME}"
          echo "GITHUB_WORKSPACE: ${GITHUB_WORKSPACE}"
          echo "GITHUB_SHA: ${GITHUB_SHA}"
          echo "GITHUB_REF: ${GITHUB_REF}"
          echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com --username ${GITHUB_ACTOR} --password-stdin &> /dev/null
          make pull
          echo -n ' - check available: '
          docker images | grep -oP 'alpine-zopfli'

      - name: Start running xqerl
        run: |
          make up
          printf %60s | tr ' ' '-' && echo
      - name: xq commands check
        run: |
          echo ' list "xq" available commands'
          echo '> xq'
          xq
          printf %60s | tr ' ' '-' && echo
      - name: Stop running xqerl
        run: | 
          make down
          printf %60s | tr ' ' '-' && echo
